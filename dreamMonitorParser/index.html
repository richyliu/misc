<html>

<head>
    <title>dream monitor data</title>
</head>

<body>

    <div id="container" style="height: 300px"></div>

    <script src="jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.5.2/firebase.js"></script>
    <script src="jquery.canvasjs.min.js"></script>
    <script>
        $.get('/Users/xlanzhou/Downloads/dreamData/2016-11-14.txt', function(resp) {
            callback(resp.split('\n'));
        });


        function callback(data) {
            let timestamp = parseInt(data[0]) - 7 * 3600 * 1000; // change utc to pst
            console.log(timestamp);
            let startDate = new Date(timestamp);
            let gyroX = [];
            let gyroY = [];
            let gyroZ = [];
            let acc = [];
            let genMov = [];
            let mov = [];

            for (let i = 1; i < data.length; i++) {
                let split = data[i].split(',');

                // ignore accelerometer data if all other data are 0
                if (data[i] === '-' || data[i].slice(-1) === '-') {
                    split = ['0', '0', '0', '0'];
                    genMov.push(0);
                } else {
                    genMov.push(1);
                }

                acc.push(parseInt(split[0]));
                gyroX.push(parseInt(split[1]));
                gyroY.push(parseInt(split[2]));
                gyroZ.push(parseInt(split[3]));
            }


            // filter genMov to get mov
            let zerosInARow = 0;
            let zerosInARowStart = 0;
            // let inARow = 300;
            let inARow = 1000;
            for (let j = 0; j < genMov.length; j++) {
                if (genMov[j] === 1) {
                    mov.push(1);
                    zerosInARow = 0;
                } else if (genMov[j] === 0 && zerosInARow < inARow) {
                    if (zerosInARow === 0) {
                        // first one
                        zerosInARowStart = j;
                    }
                    zerosInARow++;
                    mov.push(1);
                } else if (genMov[j] === 0 && zerosInARow === inARow) {
                    // don't run this again
                    zerosInARow = inARow + 1;
                    mov.push(0);

                    // change all the mov ones before to 0 (they were 0 in genMov)
                    for (let k = zerosInARowStart; k < j; k++) {
                        mov[k] = 0;
                    }
                    zerosInARowStart = 0;
                } else if (genMov[j] === 0 && zerosInARow === inARow + 1) {
                    mov.push(0);
                }
            }

            genMov = genMov.map(item => {
                return {
                    x: startDate.setMilliseconds(startDate.getMilliseconds() + 200),
                    y: item
                };
            });
            mov = mov.map(item => {
                return {
                    x: startDate.setMilliseconds(startDate.getMilliseconds() + 200),
                    y: item
                };
            });

            console.log('calculations finished!');


            let chart = new CanvasJS.Chart('container', {
                title: {
                    text: 'Movement'
                },
                zoomEnabled: true,
                data: [{
                    type: 'area',
                    xValueType: 'dateTime',
                    // dataPoints: genMov
                }, {
                    type: 'area',
                    xValueType: 'dateTime',
                    dataPoints: mov
                }]
            });

            chart.render();
        }
    </script>
</body>

</html>