<html>

<head>
    <title>dream monitor data</title>
</head>

<body>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>


    <div id="container" style="width: 1600px; height: 450px; margin: 0 auto"></div>


    <script>
        /* global $ */


        $.get('data.txt', function(resp) {
            var data = resp.split('\n');
            var timestamp = parseInt(data[0]) - 7 * 3600 * 1000; // change utc to pst
            var gyroX = [];
            var gyroY = [];
            var gyroZ = [];
            var acc = [];
            var genMov = [];
            var mov = [];

            for (var i = 1; i < data.length; i++) {
                var split = data[i].split(',');

                // ignore accelerometer data if all other data are 0
                if (data[i] === '-' || data[i].slice(-1) === '-') {
                    split = ['0', '0', '0', '0'];
                    genMov.push(0);
                } else {
                    genMov.push(1);
                }

                acc.push(parseInt(split[0]));
                gyroX.push(parseInt(split[1]));
                gyroY.push(parseInt(split[2]));
                gyroZ.push(parseInt(split[3]));
            }


            // filter genMov to get mov
            var zerosInARow = 0;
            var zerosInARowStart = 0;
            // let inARow = 300;
            let inARow = 1000;
            for (var j = 0; j < genMov.length; j++) {
                if (genMov[j] === 1) {
                    mov.push(1);
                    zerosInARow = 0;
                } else if (genMov[j] === 0 && zerosInARow < inARow) {
                    if (zerosInARow === 0) {
                        // first one
                        zerosInARowStart = j;
                    }
                    zerosInARow++;
                    mov.push(1);
                } else if (genMov[j] === 0 && zerosInARow === inARow) {
                    // don't run this again
                    zerosInARow = inARow + 1;
                    mov.push(0);

                    // change all the mov ones before to 0 (they were 0 in genMov)
                    for (var k = zerosInARowStart; k < j; k++) {
                        mov[k] = 0;
                    }
                    zerosInARowStart = 0;
                } else if (genMov[j] === 0 && zerosInARow === inARow + 1) {
                    mov.push(0);
                }
            }

            acc = [];
            // gyroX = [];
            // gyroY = [];
            // gyroZ = [];
            // genMov = [];
            mov = [];

            console.log('calculations finished!');


            $('#container').highcharts({
                chart: {
                    zoomType: 'x',
                    type: 'area'
                },
                title: {
                    text: 'Movement',
                    x: -20 //center
                },
                plotOptions: {
                    area: {
                        // pointStart: 1940,
                        marker: {
                            enabled: false,
                            symbol: 'circle',
                            radius: 2,
                            states: {
                                hover: {
                                    enabled: true
                                }
                            }
                        }
                    }
                },
                xAxis: {
                    type: 'datetime'
                },
                yAxis: [
                    {
                        title: {
                            text: 'Gyro Movement'
                        },
                        min: -70,
                        max: 70,
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#808080'
                        }]
                    }, {
                        title: {
                            text: 'Accelerometer Movement',
                        },
                        min: -70,
                        max: 70,
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#208080'
                        }]
                    }, {
                        title: {
                            text: 'General Movement',
                        },
                        min: -2,
                        max: 2,
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#508080'
                        }]
                    }
                ],
                series: [{
                    name: 'accelerometer z',
                    data: acc,
                    yAxis: 1,
                    pointStart: timestamp,
                    pointInterval: 200 // 0.2 seconds
                }, {
                    name: 'gyroscope x',
                    data: gyroX,
                    pointStart: timestamp,
                    pointInterval: 200 // 0.2 seconds
                }, {
                    name: 'gyroscope y',
                    data: gyroY,
                    pointStart: timestamp,
                    pointInterval: 200 // 0.2 seconds
                }, {
                    name: 'gyroscope z',
                    data: gyroZ,
                    pointStart: timestamp,
                    pointInterval: 200 // 0.2 seconds
                }, {
                    name: 'combined unfiltered',
                    yAxis: 2,
                    data: genMov,
                    pointStart: timestamp,
                    pointInterval: 200 // 0.2 seconds
                }, {
                    name: 'combined filtered',
                    yAxis: 2,
                    data: mov,
                    pointStart: timestamp,
                    pointInterval: 200 // 0.2 seconds
                }]
            });
        });
    </script>
</body>

</html>
